{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="csrf-token" content="{{ csrf_token }}">
  <title>{% block title %}T&P Dashboard{% endblock %}</title>
  <link href="{% static 'css/dashboard.css' %}" rel="stylesheet" />
  <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65"
      crossorigin="anonymous"
    />
  <<style>
      :root {
        --nitap-blue: #003366;
        --nitap-orange: #ff6600;
        --nitap-light: #f8f9fa;
      }

      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: #f5f5f5;
      }

      .header {
        background: linear-gradient(
          135deg,
          var(--nitap-blue),
          var(--nitap-orange)
        );
        color: white;
        padding: 1.5rem 0;
        margin-bottom: 2rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .header h1 {
        font-weight: 700;
        font-size: 2.2rem;
        margin-bottom: 0.5rem;
      }

      .header h2 {
        font-weight: 500;
        font-size: 1.8rem;
      }

      .navbar {
        background-color: white !important;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        padding: 0.5rem 1rem;
      }

      .navbar-brand {
        font-weight: 600;
        color: var(--nitap-blue) !important;
        display: flex;
        align-items: center;
      }

      .navbar-brand img {
        margin-right: 10px;
      }

      .nav-link {
        font-weight: 500;
        color: #555 !important;
        padding: 0.5rem 1rem !important;
        border-radius: 4px;
        margin: 0 0.2rem;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
      }

      .nav-link i {
        margin-right: 6px;
        font-size: 0.9rem;
      }

      .nav-link:hover,
      .nav-link.active {
        background-color: rgba(0, 51, 102, 0.1);
        color: var(--nitap-blue) !important;
      }

      .dropdown-menu {
        border: none;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .dropdown-item {
        padding: 0.5rem 1.5rem;
        display: flex;
        align-items: center;
      }

      .dropdown-item i {
        margin-right: 8px;
        width: 18px;
        text-align: center;
      }

      .dropdown-item:hover {
        background-color: rgba(0, 51, 102, 0.1);
        color: var(--nitap-blue);
      }

      .user-greeting {
        color: var(--nitap-blue);
        font-weight: 500;
        display: flex;
        align-items: center;
      }

      .user-greeting i {
        margin-right: 6px;
      }

      .form-container {
        background-color: white;
        border-radius: 8px;
        padding: 2rem;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        margin-bottom: 2rem;
      }

      .btn-primary {
        background-color: var(--nitap-blue);
        border-color: var(--nitap-blue);
      }

      .btn-primary:hover {
        background-color: #002244;
        border-color: #002244;
      }

      .card {
        border: none;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      }

      .table {
        background-color: white;
        border-radius: 8px;
        overflow: hidden;
      }

      .table th {
        background-color: var(--nitap-blue);
        color: white;
        font-weight: 500;
      }

      .status-badge {
        padding: 0.35em 0.65em;
        border-radius: 50rem;
        font-size: 0.875em;
        font-weight: 600;
      }

      .status-pending {
        background-color: #fff3cd;
        color: #856404;
      }

      .status-approved {
        background-color: #d4edda;
        color: #155724;
      }

      .status-rejected {
        background-color: #f8d7da;
        color: #721c24;
      }

      .alert {
        border-radius: 8px;
      }

      .input-group-text {
        background-color: var(--nitap-light);
      }

      .form-control:focus,
      .form-select:focus {
        border-color: var(--nitap-blue);
        box-shadow: 0 0 0 0.25rem rgba(0, 51, 102, 0.25);
      }

      .btn-link {
        text-decoration: none;
        color: var(--nitap-blue);
        padding-left: 0;
      }

      .btn-link:hover {
        text-decoration: underline;
      }

      .iframe-container {
        height: 600px;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        margin-bottom: 1.5rem;
      }

      .iframe-container iframe {
        width: 100%;
        height: 100%;
        border: none;
      }
    </style>
  {% block css %}{% endblock css %}
</head>
<body>
   

  <div class="top-navigation-header">
    <div class="header text-center">
      <h1>National Institute of Technology, Andhra Pradesh</h1>
      <h2>Training & Placement Portal</h2>
    </div>

    <div class="navigation-menu">
      <div class="nav-dropdown">
        <a class="nav-dropdown-toggle">Students</a>
        <div class="nav-dropdown-menu">
          <a href="{% url 'verifystudents' %}" class="nav-dropdown-item">Verify Students</a>
          <a href="{% url 'updatestudentplacement' %}" class="nav-dropdown-item">Update Student Placement</a>
          <a href="{% url 'assignstudentcoordinator' %}" class="nav-dropdown-item">Assign Student Coordinator</a>
          <!-- <a href="{% url 'company_data_portal' %}" class="nav-dropdown-item">Update Student Placement</a> -->
        </div>
      </div>
      <div class="nav-dropdown">
        <a class="nav-dropdown-toggle">Companies</a>
        <div class="nav-dropdown-menu">
          <a href="{% url 'company_search' %}" class="nav-dropdown-item">Search Companies</a>
          <a href="{% url 'company_data_portal' %}" class="nav-dropdown-item">Company Data Portal</a>
        </div>
      </div>
      <div class="nav-dropdown">
        <a class="nav-dropdown-toggle">Invitations</a>
        <div class="nav-dropdown-menu">
          <a href="{% url 'company_invitations_portal' %}" class="nav-dropdown-item">Companies Invitations Data Portal</a>
          <a href="{% url 'check_company_invite_status' %}" class="nav-dropdown-item {% if page == 'invitation_status' %}active{% endif %}">Check & Send Invitation Status</a>
        </div>
      </div>
      <a href="{% url 'tpportal' %}" class="nav-menu-item {% if section == 'dashboard' %}active{% endif %}">T&P Dashboard</a>
      <a href="{% url 'logout' %}" style="background-color: red;" class="nav-menu-item {% if section == 'dashboard' %}deactive{% endif %}">Logout</a>
    </div>
  </div>
  
  {% block content %}
    <div class="main-content">
      <div class="dashboard-header">
        <div class="header-content">
          <h1>Training & Placement Dashboard</h1>
          <p>Manage company invitations and placement activities</p>
        </div>
        <span class="academic-year-badge">Academic Year 2024-25</span>
      </div>
      <div class="company-count">
        <div><strong>Total Companies Willing to Come: </strong> {{ total_count }}</div>
        <div><strong>Pending Invitations(Not responded): </strong> {{ pending_invitations }}</div>
      </div>
      <div class="dashboard-announcements-section">
        <h2> Announcements</h2>
        <div class="announcement-list">
          {% if announcements %}
            {% for a in announcements %}
              <div class="announcement-item">
                <strong>{{ a.title }}</strong>
                <small>{{ a.created_at|date:"Y-m-d H:i" }}</small>
                <p>{{ a.message }}</p>
              </div>
            {% endfor %}
          {% else %}
            <p>No announcements yet.</p>
          {% endif %}
        </div>

        <button class=""><a href="{% url 'addannouncements' %}">+ Edit / Create New Announcement</a></button>
      </div>

      <div id="announcement-modal" class="modal">
        <div class="modal-content">
          <span class="close-btn">&times;</span>
          <h3>Create New Announcement</h3>
          <form id="add-announcement-form">
            {% csrf_token %}
            <input type="text" name="title" placeholder="Title" required>
            <textarea name="message" rows="3" placeholder="Message" required></textarea>
            <button type="submit">Submit</button>
          </form>
        </div>
      </div>

      <div class="statistics-section">
        <div class="section-header">
          <h2>Branch-wise Placement Statistics</h2>
        </div>
        <form method="get" action="{% url 'tpportal' %}" class="filter-controls">
          <label for="academic_year">Select Academic Year:</label>
          <select name="academic_year" id="academic_year">
            <option value="">All Years</option>
            {% for year in academic_years %}
              <option value="{{ year }}" {% if selected_year == year %}selected{% endif %}>{{ year }}</option>
            {% endfor %}
          </select>
          <button type="submit">Show</button>
        </form>
        
        <div class="chart-container">
          <h3 class="chart-title-html">Branch-wise Placement Statistics</h3>
          <div class="chart-wrapper">
            <canvas id="branchPieChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <style>
    .dashboard-announcements-section {
      margin-top: 40px;
      background: #f9fafc;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    }

    .announcement-item {
      background: white;
      border: 1px solid #eee;
      border-radius: 8px;
      padding: 10px 15px;
      margin-bottom: 10px;
    }

    .add-announcement-btn {
      margin-top: 15px;
      padding: 8px 16px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }

    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 25%; top: 25%;
      background: rgba(0,0,0,0.5);
    }

    .modal-content {
      background: white;
      margin: auto;
      padding: 20px;
      border-radius: 12px;
      width: 90%;
      position: relative;
      align: center;
    }

    .close-btn {
      position: absolute;
      top: 10px; right: 15px;
      font-size: 24px;
      cursor: pointer;
    }

    .statistics-section {
      margin-top: 40px;
      padding: 30px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 20px;
      box-shadow: 0 15px 40px rgba(0,0,0,0.15);
      position: relative;
      z-index: 1;
    }

    .section-header h2 {
      text-align: center;
      font-size: 2.2rem;
      color: #ffffff;
      margin-bottom: 30px;
      font-weight: 700;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .filter-controls {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 15px;
      margin-bottom: 40px;
      padding: 20px;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 15px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
      backdrop-filter: blur(10px);
      position: relative;
      z-index: 2;
    }

    .filter-controls label {
      font-weight: 600;
      color: #2c3e50;
      font-size: 1.1rem;
    }

    .filter-controls select {
      padding: 12px 18px;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      background: white;
      font-size: 15px;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .filter-controls select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
    }

    .filter-controls button {
      padding: 12px 30px;
      background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 15px;
      box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
    }

    .filter-controls button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
    }

    .chart-container {
      background: rgba(255, 255, 255, 0.98);
      border-radius: 20px;
      padding: 40px 30px 60px 30px; /* Increased bottom padding */
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
      margin-top: 30px;
      margin-bottom: 50px; /* Added bottom margin */
      position: relative;
      z-index: 10; /* High z-index to ensure visibility */
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 900px; /* Increased minimum height */
    }


    .chart-title-html {
      font-size: 32px;
      font-weight: 800;
      color: #1a202c;
      margin-bottom: 40px;
      text-align: center;
      padding: 20px 0;
      position: relative;
      z-index: 11;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
      background: linear-gradient(135deg, #2d3748 0%, #4a5568 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }


    .chart-wrapper {
      position: relative;
      width: 100%;
      height: 750px; 
      max-width: 1000px;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 12;
      overflow: visible; 
      margin-bottom: 30px; 
    }

    #branchPieChart {
      max-width: 100% !important;
      max-height: 100% !important;
      position: relative;
      z-index: 13; /* Highest z-index for the canvas */
    }

    /* Enhanced visual effects */
    .statistics-section::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #ff6b6b 0%, #feca57 50%, #48dbfb 100%);
      border-radius: 20px 20px 0 0;
      z-index: 2;
    }

    .statistics-section::after {
      content: '';
      position: absolute;
      top: -2px;
      left: -2px;
      right: -2px;
      bottom: -2px;
      background: linear-gradient(45deg, #667eea, #764ba2, #667eea);
      border-radius: 22px;
      z-index: -1;
      opacity: 0.7;
    }


    .main-content {
      position: relative;
      z-index: 1;
      overflow: visible;
    }


    @media (max-width: 768px) {
      .chart-wrapper {
        height: 650px;
      }
      
      .chart-container {
        padding: 20px 15px 40px 15px;
        min-height: 750px;
      }
      
      .filter-controls {
        flex-direction: column;
        gap: 10px;
      }
      
      .chart-title-html {
        font-size: 24px;
      }
    }

    .main-content {
      padding-bottom: 80px;
    }

    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script>
    Chart.register(ChartDataLabels);

    const colors = [
        '#3742FA', // Royal Blue
        '#FF6B35', // Vibrant Orange
        '#6C5CE7', // Lavender Purple
        '#FF3838', // Bright Red
        '#2ECC71', // Green
        '#F1C40F', // Sunflower Yellow
        '#E91E63', // Pink
        '#00BCD4',  // Cyan
        '#1ABC9C', // Turquoise
        '#E67E22', // Carrot Orange
        '#16A085', // Dark Turquoise
        '#27AE60', // Nephritis Green
        '#8E44AD', // Wisteria Purple
        '#FF4757', // Vivid Red
        '#2ED573', // Emerald Green
        '#9B59B6', // Purple
        '#F39C12', // Orange
        
    ];

    const rawBranchLabels = {{ branch_labels|default:"[]"|safe }};
    const branchData = {{ branch_data|default:"[]"|safe }};
    const chartLabels = [];
    const detailedLabelsContent = [];

    rawBranchLabels.forEach(labelArray => {
        if (labelArray.length > 0) {
            chartLabels.push(labelArray[0]);

            let core = 0, non_core = 0, both = 0;
            labelArray.slice(1).forEach(detail => {
                if (detail.startsWith('core:')) {
                    core = parseInt(detail.split(':')[1]) || 0;
                } else if (detail.startsWith('non-core:')) {
                    non_core = parseInt(detail.split(':')[1]) || 0;
                } else if (detail.startsWith('both:')) {
                    both = parseInt(detail.split(':')[1]) || 0;
                }
            });
            detailedLabelsContent.push({
                branch: labelArray[0],
                core: core,
                non_core: non_core,
                both: both
            });
        }
    });

    const RadialLabelsPlugin = {
      id: 'radialLabelsPlugin',
      afterDatasetsDraw(chart) {
        const ctx = chart.ctx;
        const ds = chart.data.datasets[0];
        const meta = chart.getDatasetMeta(0);
        const centerX = (chart.chartArea.left + chart.chartArea.right) / 2;
        const centerY = (chart.chartArea.top + chart.chartArea.bottom) / 2;

        // Sort arcs by angle for better positioning
        const sortedArcs = meta.data.map((arc, i) => ({ arc, i })).sort((a, b) => {
          const angleA = (a.arc.startAngle + a.arc.endAngle) / 2;
          const angleB = (b.arc.startAngle + b.arc.endAngle) / 2;
          
          const posA = { x: centerX + Math.cos(angleA) * a.arc.outerRadius, y: centerY + Math.sin(angleA) * a.arc.outerRadius };
          const posB = { x: centerX + Math.cos(angleB) * b.arc.outerRadius, y: centerY + Math.sin(angleB) * b.arc.outerRadius };

          if (posA.y !== posB.y) return posA.y - posB.y;
          return posA.x - posB.x;
        });

        const placedLabelBoxes = [];

        sortedArcs.forEach(({ arc, i }) => {
          const value = ds.data[i];
          if (value === 0) return;

          const details = detailedLabelsContent[i];
          const branchName = details.branch;
          
          const labelLines = [
            branchName,
            `Core: ${details.core}`,
            `Non-Core: ${details.non_core}`,
            `Both: ${details.both}`
          ];

          const angle = (arc.startAngle + arc.endAngle) / 2;
          const outerRadius = arc.outerRadius;
          const initialLineOffset = 30;
          const lineLength = 70;
          const horizontalExtension = 50;

          let x_start = centerX + Math.cos(angle) * (outerRadius + initialLineOffset);
          let y_start = centerY + Math.sin(angle) * (outerRadius + initialLineOffset);

          let x_mid = centerX + Math.cos(angle) * (outerRadius + initialLineOffset + lineLength);
          let y_mid = centerY + Math.sin(angle) * (outerRadius + initialLineOffset + lineLength);

          let x_end = x_mid + (Math.cos(angle) > 0 ? horizontalExtension : -horizontalExtension);
          let y_end = y_mid;

          // Enhanced text box properties
          ctx.font = '15px "Segoe UI", Tahoma, Geneva, Verdana, sans-serif';
          const lineHeight = 20;
          let maxTextWidth = 0;
          labelLines.forEach((lineText, idx) => {
              let currentFont;
              if (idx === 0) { currentFont = 'bold 17px "Segoe UI", Tahoma, Geneva, Verdana, sans-serif'; }
              else { currentFont = 'normal 14px "Segoe UI", Tahoma, Geneva, Verdana, sans-serif'; }
              ctx.font = currentFont;
              maxTextWidth = Math.max(maxTextWidth, ctx.measureText(lineText).width);
          });

          const boxPadding = 12;
          const bulletSpace = 18;
          const boxWidth = maxTextWidth + boxPadding * 2 + bulletSpace;
          const boxHeight = labelLines.length * lineHeight + boxPadding * 2;
          const borderRadius = 8;

          let currentBoxX;
          let textAlign;
          let bulletXOffset;
          let textXOffset;

          if (Math.cos(angle) > 0) {
              textAlign = 'left';
              currentBoxX = x_end;
              bulletXOffset = boxPadding + 6;
              textXOffset = bulletXOffset + 12;
          } else {
              textAlign = 'right';
              currentBoxX = x_end - boxWidth;
              bulletXOffset = boxWidth - boxPadding - 6;
              textXOffset = bulletXOffset - 12;
          }

          let currentBoxY = y_end - boxHeight / 2;

          // Enhanced collision detection
          let overlapDetected = true;
          let maxAttempts = 300;
          const verticalSpacing = 15;

          while (overlapDetected && maxAttempts > 0) {
              overlapDetected = false;
              for (let j = 0; j < placedLabelBoxes.length; j++) {
                  const prevBox = placedLabelBoxes[j];
                  if (currentBoxX < prevBox.x + prevBox.width &&
                      currentBoxX + boxWidth > prevBox.x &&
                      currentBoxY < prevBox.y + prevBox.height + verticalSpacing &&
                      currentBoxY + boxHeight + verticalSpacing > prevBox.y) {

                      currentBoxY = prevBox.y + prevBox.height + verticalSpacing;
                      overlapDetected = true;
                      break;
                  }
              }
              maxAttempts--;
          }
          
          y_end = currentBoxY + boxHeight / 2;
          placedLabelBoxes.push({ x: currentBoxX, y: currentBoxY, width: boxWidth, height: boxHeight });

          ctx.save();

          // Enhanced leader line with gradient
          const gradient = ctx.createLinearGradient(x_start, y_start, x_end, y_end);
          gradient.addColorStop(0, colors[i % colors.length]);
          gradient.addColorStop(1, 'rgba(0,0,0,0.2)');
          
          ctx.strokeStyle = gradient;
          ctx.lineWidth = 2;
          ctx.lineCap = 'round';
          ctx.beginPath();
          ctx.moveTo(centerX + Math.cos(angle) * (outerRadius + 5), 
                     centerY + Math.sin(angle) * (outerRadius + 5));
          ctx.lineTo(x_start, y_start);
          ctx.lineTo(x_end, y_end);
          ctx.stroke();


          ctx.fillStyle = 'rgba(255, 255, 255, 0.95)'; 
          ctx.shadowColor = 'rgba(0,0,0,0.25)';
          ctx.shadowBlur = 12;
          ctx.shadowOffsetX = 0;
          ctx.shadowOffsetY = 6;
          
          ctx.beginPath();
          ctx.roundRect(currentBoxX, currentBoxY, boxWidth, boxHeight, borderRadius);
          ctx.fill();
          
          // Add stronger border for definition
          ctx.strokeStyle = 'rgba(0,0,0,0.15)';
          ctx.lineWidth = 1.5;
          ctx.stroke();
          
          ctx.shadowColor = 'transparent';

          // Enhanced colored bullet with glow effect
          ctx.fillStyle = colors[i % colors.length];
          ctx.shadowColor = colors[i % colors.length];
          ctx.shadowBlur = 6;
          const bulletX = currentBoxX + bulletXOffset;
          const bulletY = currentBoxY + boxHeight / 2;
          ctx.beginPath();
          ctx.arc(bulletX, bulletY, 5, 0, 2 * Math.PI);
          ctx.fill();
          ctx.shadowColor = 'transparent';


          ctx.textAlign = textAlign;

          labelLines.forEach((lineText, idx) => {
            let fontColor = '#1a1a1a'; 
            let fontWeight = 'normal';
            let fontSize = 15;

            if (idx === 0) {
                fontWeight = 'bold';
                fontSize = 19;
                fontColor = '#000000';
            } else {
                fontWeight = '600';
                fontSize = 15;
                fontColor = '#333333';
            }

            ctx.font = `${fontWeight} ${fontSize}px "Segoe UI", Tahoma, Geneva, Verdana, sans-serif`;
            ctx.fillStyle = fontColor;

            let textDrawX;
            if (textAlign === 'left') {
                textDrawX = currentBoxX + textXOffset;
            } else {
                textDrawX = currentBoxX + textXOffset;
            }
            
            ctx.shadowColor = 'transparent';
            
            ctx.fillText(lineText, textDrawX, currentBoxY + boxPadding + (lineHeight * (idx + 0.7)));
          });

          ctx.restore();
        });
      }
    };

    const ctx = document.getElementById('branchPieChart').getContext('2d');
    new Chart(ctx, {
      type: 'pie',
      data: {
        labels: chartLabels,
        datasets: [{
          data: branchData,
          backgroundColor: colors,
          borderColor: '#000',
          borderWidth: 2,
          hoverOffset: 20,
          hoverBorderWidth: 6
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        layout: {
          padding: {
            top: 100,
            bottom: 120,
            left: 180,
            right: 180
          }
        },
        plugins: {
          legend: {
            display: false
          },
          title: {
            display: false
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                const branchName = context.label || '';
                const value = context.parsed;
                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                const percentage = total ? ((value / total) * 100).toFixed(1) : '0.0';
                return [`${branchName}: ${value} students (${percentage}%)`];
              }
            },
            backgroundColor: 'rgba(26,32,44,0.95)',
            titleColor: '#ffffff',
            bodyColor: '#ffffff',
            borderColor: '#ffffff',
            borderWidth: 2,
            cornerRadius: 12,
            bodyFont: {
              size: 15,
              weight: '500'
            },
            titleFont: {
              size: 16,
              weight: 'bold'
            },
            padding: 12
          },
          datalabels: {
            color: function(context) {
              const bgColor = colors[context.dataIndex % colors.length];
              return '#fff'; 
            },
            formatter: (value, context) => {
              const total = context.dataset.data.reduce((a, b) => a + b, 0);
              const percentage = total ? ((value / total) * 100).toFixed(1) : '0.0';
              return `${value}\n(${percentage}%)`;
            },
            font: {
              weight: 'bold',
              size: 20,
              family: 'Arial'
            },
            display: function(context) {
              const total = context.dataset.data.reduce((a, b) => a + b, 0);
              const percentage = (context.parsed / total) * 100;
              return percentage > 3;
            },
            display:true,
            align: 'center',
            padding: 8,
            textStrokeColor: 'rgba(0,0,0,0.8)',
            textStrokeWidth: 4
          }
        },
        animation: {
          animateRotate: true,
          animateScale: true,
          duration: 2000,
          easing: 'easeOutCubic'
        },
        cutout: '45%',
        radius: '80%'
      },
      plugins: [ChartDataLabels, RadialLabelsPlugin]
    });
    document.addEventListener('DOMContentLoaded', function() {
      const modal = document.getElementById('announcement-modal');
      const btn = document.querySelector('.add-announcement-btn');
      const closeBtn = document.querySelector('.close-btn');
      const form = document.getElementById('add-announcement-form');

      btn.addEventListener('click', () => modal.style.display = 'block');
      closeBtn.addEventListener('click', () => modal.style.display = 'none');
      window.addEventListener('click', e => { if (e.target == modal) modal.style.display = 'none'; });

      form.addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(form);
        fetch("{% url 'add_announcement' %}", {
          method: "POST",
          headers: {'X-CSRFToken': '{{ csrf_token }}' },
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            location.reload();
          } else {
            alert('Failed to add announcement.');
          }
        })
        .catch(() => alert('Server error.'));
      });
    });

    </script>
  {% endblock content %}
  {% block script %}{% endblock script %}
</body>
</html>